name: Build & Deploy Extension
on:
  push:
    tags: ['v*']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}
  cancel-in-progress: true

jobs:
  build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.4
    with:
      duckdb_version: v1.4.4
      ci_tools_version: v1.4.4
      extension_name: inferal_relay
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads'

  deploy:
    name: Deploy to R2
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install AWS CLI
        run: pip install awscli

      - name: Deploy to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT }}
        run: |
          DUCKDB_VERSION="v1.4.4"
          EXT_NAME="inferal_relay"
          EXT_VERSION="${GITHUB_REF#refs/tags/v}"
          BUCKET="${{ secrets.R2_BUCKET_NAME }}"

          for artifact_dir in artifacts/*/; do
            dir_name=$(basename "$artifact_dir")
            platform="${dir_name#${EXT_NAME}-${DUCKDB_VERSION}-extension-}"

            # Skip non-extension artifacts
            if [ "$platform" = "$dir_name" ]; then
              echo "Skipping: $dir_name"
              continue
            fi

            ext_file=$(find "$artifact_dir" -name "${EXT_NAME}.duckdb_extension" -type f | head -1)
            if [ -z "$ext_file" ]; then
              echo "Warning: no extension in $artifact_dir"
              continue
            fi

            gzip -9 -k "$ext_file"
            GZ_FILE="${ext_file}.gz"

            # Upload versioned: /{NAME}/{EXT_VERSION}/{DUCKDB_VERSION}/{PLATFORM}/{NAME}.duckdb_extension.gz
            aws s3 cp "$GZ_FILE" \
              "s3://${BUCKET}/${EXT_NAME}/${EXT_VERSION}/${DUCKDB_VERSION}/${platform}/${EXT_NAME}.duckdb_extension.gz"

            # Upload latest: /{DUCKDB_VERSION}/{PLATFORM}/{NAME}.duckdb_extension.gz
            aws s3 cp "$GZ_FILE" \
              "s3://${BUCKET}/${DUCKDB_VERSION}/${platform}/${EXT_NAME}.duckdb_extension.gz"

            echo "Deployed: $platform (versioned: ${EXT_VERSION}, latest)"
          done
