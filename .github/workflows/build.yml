name: Build & Deploy Extension
on:
  push:
    tags: ['v*']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}
  cancel-in-progress: true

jobs:
  build-v1_4_0:
    name: Build (DuckDB v1.4.0)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.0
    with:
      duckdb_version: v1.4.0
      ci_tools_version: v1.4.0
      extension_name: inferal_relay
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads'

  build-v1_4_1:
    name: Build (DuckDB v1.4.1)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.1
    with:
      duckdb_version: v1.4.1
      ci_tools_version: v1.4.1
      extension_name: inferal_relay
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads'

  build-v1_4_2:
    name: Build (DuckDB v1.4.2)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.2
    with:
      duckdb_version: v1.4.2
      ci_tools_version: v1.4.2
      extension_name: inferal_relay
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads'

  build-v1_4_3:
    name: Build (DuckDB v1.4.3)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.3
    with:
      duckdb_version: v1.4.3
      ci_tools_version: v1.4.3
      extension_name: inferal_relay
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads'

  build-v1_4_4:
    name: Build (DuckDB v1.4.4)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.4
    with:
      duckdb_version: v1.4.4
      ci_tools_version: v1.4.4
      extension_name: inferal_relay
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads'

  deploy:
    name: Deploy to R2
    needs: [build-v1_4_0, build-v1_4_1, build-v1_4_2, build-v1_4_3, build-v1_4_4]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install AWS CLI
        run: pip install awscli

      - name: Deploy to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT }}
        run: |
          EXT_NAME="inferal_relay"
          EXT_VERSION="${GITHUB_REF#refs/tags/v}"
          BUCKET="${{ secrets.R2_BUCKET_NAME }}"

          for artifact_dir in artifacts/*/; do
            dir_name=$(basename "$artifact_dir")

            # Extract DuckDB version and platform from artifact name
            # Pattern: {EXT_NAME}-{DUCKDB_VERSION}-extension-{PLATFORM}
            if [[ "$dir_name" =~ ^${EXT_NAME}-(v[0-9]+\.[0-9]+\.[0-9]+)-extension-(.+)$ ]]; then
              DUCKDB_VERSION="${BASH_REMATCH[1]}"
              platform="${BASH_REMATCH[2]}"
            else
              echo "Skipping: $dir_name"
              continue
            fi

            ext_file=$(find "$artifact_dir" -name "${EXT_NAME}.duckdb_extension" -type f | head -1)
            if [ -z "$ext_file" ]; then
              echo "Warning: no extension in $artifact_dir"
              continue
            fi

            gzip -9 -k "$ext_file"
            GZ_FILE="${ext_file}.gz"

            # Upload versioned: /{NAME}/{EXT_VERSION}/{DUCKDB_VERSION}/{PLATFORM}/{NAME}.duckdb_extension.gz
            aws s3 cp "$GZ_FILE" \
              "s3://${BUCKET}/${EXT_NAME}/${EXT_VERSION}/${DUCKDB_VERSION}/${platform}/${EXT_NAME}.duckdb_extension.gz"

            # Upload latest: /{DUCKDB_VERSION}/{PLATFORM}/{NAME}.duckdb_extension.gz
            aws s3 cp "$GZ_FILE" \
              "s3://${BUCKET}/${DUCKDB_VERSION}/${platform}/${EXT_NAME}.duckdb_extension.gz"

            echo "Deployed: ${DUCKDB_VERSION}/${platform} (versioned: ${EXT_VERSION}, latest)"
          done
